"use strict";(globalThis.webpackChunk_croquet_microverse=globalThis.webpackChunk_croquet_microverse||[]).push([[636],{8636:(e,t,s)=>{s.r(t),s.d(t,{default:()=>i});const i={modules:[{name:"PDFView",actorBehaviors:[class PDFActor{setup(){void 0===this.numPages&&(this.numPages=null,this.pageGapPercent=null,this.scrollPosition=null),this.listen("docLoaded","docLoaded"),this.listen("changePage","changePage"),this.listen("scrollByPercent","scrollByPercent"),this.listen("requestScrollPosition","requestScrollPosition"),console.log(this)}viewJoined(e){}viewExited(e){}docLoaded(e){this.numPages=e.numPages,this.pageGapPercent=e.pageGapPercent,null===this.scrollPosition&&(this.scrollPosition={page:1,percent:0}),this.say("drawAtScrollPosition")}changePage(e){let{page:t,percent:s}=this.scrollPosition;(0<e||s<=0)&&(t+=e),0===t?t=this.numPages:t>this.numPages&&(t=1),s=0,this.scrollPosition={page:t,percent:s},this.say("drawAtScrollPosition")}requestScrollPosition({page:e,percent:t}){var{page:e,percent:t}=this.normalizeScroll(e,t);this.announceScrollIfNew(e,t)}scrollByPercent(e){var{page:t,percent:s}=this.scrollPosition,{page:t,percent:e}=this.normalizeScroll(t,s+=e);this.announceScrollIfNew(t,e)}normalizeScroll(e,t){for(var s=this.pageGapPercent;t<-s&&1<e;)e--,t+=100+s;for(;100<t&&e<this.numPages;)e++,t-=100+s;return 1===e&&t<0?t=0:e===this.numPages&&90<t&&(t=90),{page:e,percent:t}}announceScrollIfNew(e,t){var{page:s,percent:i}=this.scrollPosition;e===s&&t===i||(this.scrollPosition={page:e,percent:t},this.say("drawAtScrollPosition"))}}],pawnBehaviors:[class PDFPawn{setup(){window.pdfjsPromise||(window.pdfjsPromise=new Promise(t=>{const e=document.createElement("script");e.setAttribute("src","https://unpkg.com/pdfjs-dist@2.14.305/build/pdf.min.js"),e.onload=()=>{const e=window["pdfjs-dist/build/pdf"];e.GlobalWorkerOptions.workerSrc="https://unpkg.com/pdfjs-dist@2.14.305/build/pdf.worker.min.js",t(e)},document.body.appendChild(e)})),this.addEventListener("pointerDown","onPointerDown"),this.addEventListener("pointerMove","onPointerMove"),this.addEventListener("pointerUp","onPointerUp"),this.addEventListener("keyDown","onKeyDown"),this.addEventListener("pointerWheel","onPointerWheel"),this.listen("drawAtScrollPosition","drawAtScrollPosition");var e=this._behavior.module.externalName;if(this.addUpdateRequest([e+"$PDFPawn","update"]),this.pages){const s=this.pageMeshPool;this.shape.children.slice().forEach(e=>{"page"===e.name&&(this.shape.remove(e),s.push(e))}),s.forEach(e=>{e.geometry.dispose(),e.material.dispose()}),this.pages.forEach(e=>{e.texture&&e.texture.dispose()})}this.substrateObj=this.shape.children.find(e=>"2d"===e.name),this.TEXTURE_SIZE=2048,this.numPages=null,this.pages=[],this.visiblePages=[],this.renderQueue=[],this.renderingPage=!1,this.pageMeshPool=[],console.log(this);const t=this.pdf?Promise.resolve():this.loadDocument(this.actor._cardData.pdfLocation);t.then(()=>{this.numPages=this.pdf.numPages,this.ensurePageEntry(1)})}async loadDocument(e){e=await this.getBuffer(e),e=URL.createObjectURL(new Blob([e]));try{const s=await window.pdfjsPromise;this.pdf=await s.getDocument(e).promise;var t=this.pdf.numPages;console.log(`PDF with ${t} pages loaded`)}catch(e){console.error(e.message)}URL.revokeObjectURL(e)}drawAtScrollPosition(){if(this.pdf&&this.pageGap){var e=this.actor["scrollPosition"];if(e){const P=this.pageMeshPool;this.shape.children.slice().forEach(e=>{"page"===e.name&&(this.shape.remove(e),P.push(e))}),P.forEach(e=>{this.visiblePages[e.lastAssignedPage]||delete e.lastAssignedPage});var r=this.actor._cardData["depth"],{cardWidth:n,cardHeight:o}=this,{page:e,percent:t}=e;let s=e,i=t/100,a=0;for(;;){const m=this.ensurePageEntry(s);var{renderResult:h,aspectRatio:l}=m;if(void 0===l)return;l=n/l;if(h){let e,t=P.findIndex(e=>e.lastAssignedPage===s);t<0&&(t=P.findIndex(e=>!e.lastAssignedPage)),(e=t<0?this.makePageMesh():P.splice(t,1)[0]).lastAssignedPage=s,e.geometry.dispose();var d=Math.max(0,i),c=i<0?-i*o:0,g=Math.min((1-d)*l,o-a-c),p=d+g/l,u=e.geometry=new THREE.PlaneGeometry(n,g),c=(this.shape.add(e),o/2-a-c-g/2);e.position.set(0,c,r/2+.001);const w=u.attributes.uv;w.setXY(0,0,1-d),w.setXY(1,1,1-d),w.setXY(2,0,1-p),w.setXY(3,1,1-p),w.needsUpdate=!0,m.texture||(m.texture=new THREE.Texture(h)),e.material.map!==m.texture&&(e.material.map=m.texture,m.texture.needsUpdate=!0)}if(a+=l-l*i+this.pageGap,s===this.numPages||a>=o)return;s++,i=0}}}}makePageMesh(){var{cardWidth:e,cardHeight:t}=this,e=new THREE.PlaneGeometry(e,t),t=new THREE.MeshBasicMaterial({color:"#fff",side:THREE.DoubleSide,toneMapped:!1});const s=new THREE.Mesh(e,t);return s.name="page",s}updateVisiblePages(){var i=this.actor["scrollPosition"];if(i&&this.pageGap){var{page:i,percent:a}=i,{cardWidth:r,cardHeight:n}=this,o=this.visiblePages;const l=this.visiblePages=[];let e=i,t=a/100,s=0;for(;;){if(o[e]?l[e]=o[e]:l[e]=Date.now(),e===this.numPages)return;var h=this.ensurePageEntry(e)["aspectRatio"];if(void 0===h)return;h=r/h;if((s+=h-t*h+this.pageGap)>=n)return;e++,t=0}}}manageRenderState(){var e=this.actor["scrollPosition"];if(e&&this.pageGap){const i=e["page"],a=this["numPages"],r=this.renderQueue=[];var t=e=>{e<1?e+=a:e>a&&(e-=a);var t=this.ensurePageEntry(e);t.page&&!t.renderTask&&r.push(e)},s=Math.min(a,4);for(let e=1;e<s;e++)t(i+e),t(i-e);this.pages.forEach((e,t)=>{var s;t!==i&&(s=!!this.visiblePages[t],e.renderResult&&(5<(t>i?Math.min(t-i,i+a-t):Math.min(i-t,t+a-i))&&(e.renderResult=null,e.renderTask=null),e.texture&&!s&&(e.texture.dispose(),e.texture=null)))})}}processRenderQueue(){const e=this.visiblePages;if(!this.renderingPage||!e[this.renderingPage]){const i=!1===this.renderingPage?0:200,a=Date.now();if(e.forEach((e,t)=>{a-e<i||(e=this.ensurePageEntry(t)).page&&!e.renderTask&&this.startRendering(t)}),!this.renderingPage){const r=this.renderQueue;var t,s;0!==r.length&&(t=r[0],(s=this.ensurePageEntry(t)).page&&(r.shift(),s.renderTask||this.startRendering(t)))}}}startRendering(e){if(this.renderingPage){const t=this.ensurePageEntry(this.renderingPage);t.renderTask.cancel()}this.renderingPage=e;const t=this.ensurePageEntry(e),{page:s,renderScale:i}=t,a=s.getViewport({scale:i}),r=(this.renderCanvas||(this.renderCanvas=document.createElement("canvas")),this.renderCanvas),n=r.getContext("2d");r.height=a.height,r.width=a.width;var o={canvasContext:n,viewport:a};const h=t.renderTask=s.render(o);h.promise.then(()=>{this.renderingPage=null,t.renderResult=n.getImageData(0,0,a.width,a.height),this.finishedRendering(e)},()=>{t.renderTask=null})}finishedRendering(e){this.visiblePages[e]&&this.drawAtScrollPosition()}adjustCardSize(e,t){var s=this.actor._cardData["depth"],i=1/Math.max(e,t),a=this.cardWidth=e*i,i=this.cardHeight=t*i;const r=this.substrateObj;r.geometry.dispose(),r.geometry=this.squareCornerGeometry(a,i,s);a=t<e?2:e===t?1.5:1;this.pageGap=i*a/100,this.actor.numPages||this.say("docLoaded",{pageGapPercent:a,numPages:this.numPages})}squareCornerGeometry(e,t,s){var i=t/2,a=e/2,r=s/2;let n=new THREE.Shape,o=(n.moveTo(-i,-a),n.lineTo(-i,a),n.lineTo(i,a),n.lineTo(i,-a),n.lineTo(-i,-a),new THREE.LineCurve3(new THREE.Vector3(0,0,r),new THREE.Vector3(0,0,-r))),h=(o.arcLengthDivisions=3,new THREE.ExtrudeGeometry(n,{extrudePath:o}));return h.parameters.width=e,h.parameters.height=t,h.parameters.depth=s,h}ensurePageEntry(i){var e=this.pages[i];if(e)return e;const a={renderResult:null,renderTask:null};return this.pages[i]=a,this.pdf.getPage(i).then(e=>{var{width:e,height:t}=(a.page=e).getViewport({scale:1}),s=(a.width=e,a.height=t,Math.max(e,t)),s=this.TEXTURE_SIZE/s*.999;a.renderScale=s,a.aspectRatio=e/t,1===i&&this.adjustCardSize(e,t)}),a}onPointerDown(e){e.uv&&(this.pointerDownTime=Date.now(),this.pointerDownY=e.xyz[1],this.pointerDownScroll={...this.actor.scrollPosition},this.pointerDragRange=0)}onPointerMove(e){var t,s,i;!e.uv||(t=Date.now())-(this.lastPointerMove||0)<50||(this.lastPointerMove=t,{page:t,percent:s}=this.pointerDownScroll,i=this.actor._scale[1],e=(e.xyz[1]-this.pointerDownY)/this.cardHeight/i*100,this.pointerDragRange=Math.max(this.pointerDragRange,Math.abs(e)),this.say("requestScrollPosition",{page:t,percent:s+e}))}onPointerUp(e){e.uv&&this.pointerDragRange<2&&Date.now()-this.pointerDownTime<250&&this.changePage(1)}onPointerWheel(e){if(this.pdf&&this.pageGap){var t=Date.now();if(this.cumulativeWheelDelta=(this.cumulativeWheelDelta||0)+e.deltaY,!(t-(this.lastPointerWheel||0)<50)){this.lastPointerWheel=t;let e=4*this.cumulativeWheelDelta/this.TEXTURE_SIZE*100;50<Math.abs(e)&&(e=50*Math.sign(e)),this.cumulativeWheelDelta=0,this.say("scrollByPercent",e)}}}onKeyDown(e){if(!e.repeat)switch(e.key){case"ArrowLeft":case"ArrowUp":this.changePage(-1);break;case"ArrowRight":case"ArrowDown":this.changePage(1)}}changePage(e){this.say("changePage",e)}onKeyUp(e){}update(){this.updateVisiblePages(),this.manageRenderState(),this.processRenderQueue()}teardown(){const e=this.substrateObj;e.geometry.dispose(),this.material.dispose(),this.pageMeshPool.forEach(e=>{e.geometry.dispose(),e.material.dispose()}),this.pages.forEach(e=>{e.texture&&e.texture.dispose()})}}]}]}}}]);